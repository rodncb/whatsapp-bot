const { Client, LocalAuth } = require("whatsapp-web.js");
const qrcode = require("qrcode-terminal");
require("dotenv").config();

const ArceeAIAgent = require("./ai-agent");
const MessageHandler = require("./message-handler");
const audioHandler = require("./audio-handler");
const conversationMemory = require("./conversation-memory");

// ConfiguraÃ§Ãµes
const OWNER_PHONE = process.env.OWNER_PHONE || "552299871594"; // Ana ClÃ¡udia
const BOT_NAME = process.env.BOT_NAME || "Ana ClÃ¡udia";

// Verifica se suporte a Ã¡udio estÃ¡ habilitado
const AUDIO_ENABLED = audioHandler.isAudioEnabled();
if (AUDIO_ENABLED) {
  console.log("ğŸ¤ Suporte a ÃUDIO HABILITADO (OpenAI Whisper)");
} else {
  console.log(
    "ğŸ“ Modo TEXTO apenas (configure OPENAI_API_KEY para habilitar Ã¡udio)"
  );
}

console.log("\nâš ï¸  BOT DE PRODUÃ‡ÃƒO - Ana ClÃ¡udia");
console.log("ğŸ“± NÃºmero: +55 22 99871-5947");
console.log("ğŸ¯ Modo: ConversaÃ§Ã£o humanizada (Arcee.ai)");
console.log("âŒ SEM respostas automÃ¡ticas - Tudo via IA\n");

// Inicializa componentes
const aiAgent = new ArceeAIAgent();
const messageHandler = new MessageHandler(aiAgent);

// ConfiguraÃ§Ã£o do cliente WhatsApp
const client = new Client({
  authStrategy: new LocalAuth({
    dataPath: "./.wwebjs_auth",
  }),
  puppeteer: {
    headless: true,
    executablePath:
      "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome",
    args: [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-dev-shm-usage",
      "--disable-accelerated-2d-canvas",
      "--no-first-run",
      "--no-zygote",
      "--disable-gpu",
    ],
  },
});

// Eventos do WhatsApp
client.on("qr", (qr) => {
  console.log("\nğŸ” ESCANEIE O QR CODE ABAIXO COM O WHATSAPP:\n");
  qrcode.generate(qr, { small: true });
  console.log(
    "\nğŸ“± Abra o WhatsApp â†’ Aparelhos Conectados â†’ Conectar Aparelho\n"
  );
});

client.on("ready", () => {
  console.log("\nâœ… Bot conectado com sucesso!");
  console.log(`ğŸ¤– ${BOT_NAME} estÃ¡ online e pronto para atender!`);
  console.log("ğŸ“Š Aguardando mensagens...\n");
  console.log("=".repeat(50));

  // Limpa conversas antigas a cada 24h
  setInterval(() => {
    messageHandler.cleanOldConversations();
  }, 24 * 60 * 60 * 1000);
});

client.on("authenticated", () => {
  console.log("ğŸ”“ AutenticaÃ§Ã£o realizada com sucesso!");
});

client.on("auth_failure", (msg) => {
  console.error("âŒ Falha na autenticaÃ§Ã£o:", msg);
  console.log("ğŸ’¡ Tente deletar a pasta .wwebjs_auth e reconectar");
});

client.on("disconnected", (reason) => {
  console.log("âš ï¸  Bot desconectado:", reason);
  console.log("ğŸ”„ Tentando reconectar...");
});

// Processa mensagens recebidas
client.on("message", async (msg) => {
  try {
    // Ignora mensagens de grupos e status
    if (msg.from.includes("@g.us") || msg.from === "status@broadcast") {
      return;
    }

    // Ignora mensagens prÃ³prias
    if (msg.fromMe) {
      return;
    }

    const chatId = msg.from;
    const contact = await msg.getContact();
    const contactName = contact.pushname || contact.name || chatId;

    // ========================================
    // DETECTA LEAD DO FACEBOOK
    // ========================================
    const isAdLead = conversationMemory.isFromFacebookAd(msg.body);
    const leadSource = isAdLead ? "facebook_ad" : "direct";

    console.log("\n" + "=".repeat(50));

    if (isAdLead) {
      console.log(`ğŸ¯ [LEAD ANÃšNCIO FB] Novo lead detectado!`);
      console.log(`ï¿½ RegiÃ£o: Campos dos Goytacazes/RJ`);
      console.log(`ğŸ’¬ Origem: AnÃºncio Facebook`);
    }

    console.log(`ï¿½ğŸ“© Mensagem de: ${contactName}`);
    console.log(`ğŸ“± NÃºmero: ${chatId}`);
    console.log(`ğŸ“ Tipo: ${msg.type}`);
    console.log(`â° HorÃ¡rio: ${new Date().toLocaleString("pt-BR")}`);

    // ========================================
    // SALVA MENSAGEM DO CLIENTE NO BD
    // ========================================
    const messageContent = msg.body || `[${msg.type}]`;
    conversationMemory.saveMessage(
      chatId,
      contactName,
      msg.type,
      messageContent,
      false, // nÃ£o Ã© do bot
      msg.timestamp,
      {
        leadSource,
        isAdLead,
      }
    );

    // ========================================
    // PROCESSA ÃUDIO (se habilitado)
    // ========================================
    if (msg.type === "ptt" || msg.type === "audio") {
      console.log("ğŸ¤ Ãudio recebido");

      if (AUDIO_ENABLED) {
        // ÃUDIO HABILITADO: Transcreve com OpenAI Whisper
        try {
          console.log("ğŸ”„ Transcrevendo Ã¡udio com OpenAI Whisper...");

          const chat = await msg.getChat();
          await chat.sendStateTyping();

          // Transcreve o Ã¡udio
          const transcription = await audioHandler.processWhatsAppAudio(msg);

          console.log(`ğŸ’¬ TranscriÃ§Ã£o: ${transcription}`);
          console.log(`ğŸ• HorÃ¡rio: ${new Date().toLocaleString("pt-BR")}`);

          // Salva transcriÃ§Ã£o no BD
          conversationMemory.saveMessage(
            chatId,
            contactName,
            "audio_transcribed",
            transcription,
            false, // Ã© do cliente (transcriÃ§Ã£o)
            msg.timestamp
          );

          // Busca contexto da conversa anterior
          const context = conversationMemory.getContextForAI(chatId, 10);

          // Processa como texto normal com Arcee.ai
          await chat.sendStateTyping();
          const response = await messageHandler.handleMessage(
            chatId,
            transcription,
            context
          );

          // Simula tempo de digitaÃ§Ã£o
          const typingTime = Math.random() * 2000 + 1000;
          await new Promise((resolve) => setTimeout(resolve, typingTime));

          await msg.reply(response.reply);
          console.log(
            `ğŸ¤– Resposta enviada: ${response.reply.substring(0, 100)}...`
          );

          // Salva resposta do bot no BD
          conversationMemory.saveMessage(
            chatId,
            BOT_NAME,
            "text",
            response.reply,
            true, // Ã© do bot
            Date.now() / 1000
          );

          // Notifica o dono se necessÃ¡rio
          if (response.shouldNotifyOwner) {
            await notifyOwner(response.reason, response.contactInfo, chatId);
          }
        } catch (audioError) {
          console.error("âŒ Erro ao processar Ã¡udio:", audioError.message);
          await msg.reply(
            "Desculpe, tive um probleminha ao processar seu Ã¡udio. Pode digitar sua mensagem? ğŸ˜Š"
          );
        }
      } else {
        // ÃUDIO DESABILITADO: Pede para enviar texto
        console.log("âš ï¸  Ãudio nÃ£o habilitado, pedindo texto");
        await msg.reply(`Oi! ğŸ˜Š 

Recebi seu Ã¡udio, mas para te atender melhor, vocÃª pode digitar sua mensagem? 

Assim consigo te responder mais rÃ¡pido! ğŸ“`);
      }

      console.log("=".repeat(50) + "\n");
      return;
    }

    // ========================================
    // PROCESSA TEXTO (Arcee.ai)
    // ========================================
    console.log(`ğŸ’¬ ConteÃºdo: ${msg.body}`);
    console.log(`ğŸ• HorÃ¡rio: ${new Date().toLocaleString("pt-BR")}`);

    // Busca contexto da conversa anterior
    const context = conversationMemory.getContextForAI(chatId, 10);

    // Indicador de digitaÃ§Ã£o
    const chat = await msg.getChat();
    await chat.sendStateTyping();

    // Processa mensagem com IA
    const response = await messageHandler.handleMessage(
      chatId,
      msg.body,
      context
    );

    // Simula tempo de digitaÃ§Ã£o humano (1-3 segundos)
    const typingTime = Math.random() * 2000 + 1000;
    await new Promise((resolve) => setTimeout(resolve, typingTime));

    // Envia resposta
    await msg.reply(response.reply);
    console.log(`ğŸ¤– Resposta enviada: ${response.reply.substring(0, 100)}...`);

    // Salva resposta do bot no BD
    conversationMemory.saveMessage(
      chatId,
      BOT_NAME,
      "text",
      response.reply,
      true, // Ã© do bot
      Date.now() / 1000
    );

    // Notifica o dono se necessÃ¡rio
    if (response.shouldNotifyOwner) {
      await notifyOwner(response.reason, response.contactInfo, chatId);
    }

    console.log("=".repeat(50) + "\n");
  } catch (error) {
    console.error("âŒ Erro ao processar mensagem:", error);

    try {
      await msg.reply(
        "Desculpe, tive um probleminha aqui. Pode repetir sua mensagem? ğŸ˜Š"
      );
    } catch (replyError) {
      console.error("âŒ Erro ao enviar mensagem de erro:", replyError);
    }
  }
});

/**
 * Notifica o dono quando um lead importante chega
 */
async function notifyOwner(reason, contactInfo, chatId) {
  try {
    const ownerNumber = OWNER_PHONE.includes("@c.us")
      ? OWNER_PHONE
      : `${OWNER_PHONE}@c.us`;

    const message = `ğŸš¨ *ALERTA - LEAD QUENTE!*

${reason}

ğŸ“‹ *InformaÃ§Ãµes do Cliente:*
ğŸ‘¤ Nome: ${contactInfo.name}
ğŸ’¼ Trabalho: ${contactInfo.workType}
ğŸ’° Renda: ${contactInfo.income}
ğŸ‚ Idade: ${contactInfo.age}
ğŸ“¨ Mensagens trocadas: ${contactInfo.messagesCount}
ğŸ• Iniciou em: ${contactInfo.startedAt.toLocaleString("pt-BR")}

âš¡ *ENTRE EM CONTATO AGORA!*
Chat ID: ${chatId}`;

    await client.sendMessage(ownerNumber, message);
    console.log("ğŸ“¢ NotificaÃ§Ã£o enviada ao dono!");
  } catch (error) {
    console.error("âŒ Erro ao notificar dono:", error);
  }
}

// Tratamento de erros globais
process.on("unhandledRejection", (reason, promise) => {
  console.error("âŒ Unhandled Rejection:", reason);
});

process.on("uncaughtException", (error) => {
  console.error("âŒ Uncaught Exception:", error);
  // NÃ£o encerra o processo, tenta manter o bot rodando
});

// Graceful shutdown
process.on("SIGINT", async () => {
  console.log("\n\nâš ï¸  Encerrando bot...");
  await client.destroy();
  console.log("âœ… Bot encerrado com sucesso!");
  process.exit(0);
});

// Inicia o bot
console.log("ğŸš€ Iniciando WhatsBot com IA...");
console.log(`ğŸ¤– Nome: ${BOT_NAME}`);
console.log(`ğŸ¢ Empresa: ${process.env.COMPANY_NAME}`);
console.log("\nâ³ Aguardando QR Code...\n");

client.initialize();
